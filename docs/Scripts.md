# Scripts Documentation fo Xarxa

All scripts used to interact with the database are located in the `src` directory,
although some pre-build workflows (bash scripts) are provided in the `workflows` directory.

All scripts provide a help message that can be accessed by running the script with the `-h` or `--help` option. The help message will provide information about the script's purpose, usage, options and some examples.

All scripts print expected output (if any) to the standard output. Any
other information, such as logs, warnings, and error messages, are printed to the standard error.

The scripts are designed to be run in pipelines, where the output of one script is the input of the next one. Data fetching and processing has been separated for easier debugging and maintenance.

Data format of choice is tabular, where each row represents a record and each column represents a field/atribute for that record. Columns are separated by tabs. Columns may contain different types of data, such as strings, integers, arrays, or no value at all. Each type representation is described below:

- Strings are represented as they are.
- Integers are represented as they are.
- Arrays are represented as a string with the elements separated by semicolons.
- Dictionary and JSON objects are represented as canonic JSON strings.
- The NoneType value is represented as a "NULL" string.

*Example of and hypotetical tabular file generated by the scripts:*

```text
P12345  LT1;LT2;LT3  R12345  +  1  100  MAAKQ
P12346  LT4  R12346  -  200  300  MAAKQ
P12347  NULL R12347  +  400  500  MAAKQ
P12348  LT5  R12348;R12349  -  600  700  NULL
```

## Table of Contents

- [Script Listings](#script-listings)
    - [Data Fetching Scripts](#data-fetching-scripts)
    - [Data Preprocessing Scripts](#data-preprocessing-scripts)
    - [Data Insertion Scripts](#data-insertion/Update-scripts)
    - [Utility Scripts](#utility-scripts)
- [Script Details](#script-details)
    - [create_id_master_table.py](#create_id_master_tablepy)
    - [fetch_uniprot_organism_ids.py](#fetch_uniprot_organism_idspy)
    - [upsert_table.py](#upsert_tablepy)
        - [uniprot_organism](#uniprot_organism)
        - [refseq_genome](#refseq_genome)

## Script Listings

### Data Fetching Scripts

Scripts used to fetch data from external sources. 

These scripts are designed to retrieve data from various sources and format it for further processing or insertion into the database.

The fetched data is printed to stdout in a tab-separated format. **No headers are included in the output.**

#### Links:

- [`fetch_kegg_organism.py`](#fetch_kegg_organismpy)
- [`fetch_kegg_relations.py`](#fetch_kegg_relationspy)
- [`fetch_refseq_genome.py`](#fetch_refseq_genomepy)
- [`fetch_uniprot_organism_json.py`](#fetch_uniprot_organism_jsonpy)

### Data Preprocessing Scripts

Scripts that preprocess data before insertion into the database.

The formatted data is printed to stdout in a tab-separated format. **No headers are included in the output.**

#### Links:

- [`process_uniprot_json_entry.py`](#process_uniprot_json_entrypy)
- [`match_ids.py`](#match_idspy)

### Data Insertion/Update Scripts

Scripts that facilitate the insertion of new data into the database. This includes protocols for handling and validating new entries.

#### Links:

- [`upsert_table.py`](#upsert_tablepy)

### Utility Scripts

Scripts designed to update existing records within the database. These scripts ensure data remains current and correct.
Maintenance Scripts

Scripts for database maintenance tasks such as backup, data cleaning, and performance optimization.

#### Links:


- [`build_graph.py`](#build_graphpy)
- [`printval.py`](#printvalpy)
- [`tab_to_fasta.py`](#tab_to_fastapy)

## Script Details

### build_graph.py

#### Description

Given a list of  identifiers, this script will build a graph representing the
relationships where the identifiers are involved.

Relationships are defined by the following rules:

1. If the query identifier acts as a source in any of the KEGG relationships,
   the relationship is added to the graph as a directed edge.
2. If the query identifier is found as source in any of the STRING relationships,
   the combined score is higher than a given threshold and the relationship
   is not already present in the graph, the relationship is added to the graph
   as an undirected edge.

The degree of neighbors for which the graph is built can be controlled with the
'-d / --depth' option. By default, the graph will only contain the query identifier
and the relationships in which it is involved (depth=1). A depth of 2 will include
the second degree neighbors or, in other words, the neighbors of the neighbors of the
query identifier(s).

#### Usage

```shell
python src/build_graph.py [options] <file>
```

#### Parameters

| Parameter | Description | Type | Default Value | Required |
|-----------|-------------|------|---------------|----------|
| `<file>` | File containing list of identifiers, or '-' for stdin | String | '-' | Yes |
| `--depth` | Depth of the graph | Integer | 1 | No |
|  `-S`, `--string-threshold` | STRING combined score threshold. Range: 0-1000 | Integer | 800 | No |
| `--db` | Database connection string | String | Reads from `config/database.json` | No |
| `--log` | Log file path | String | INFO | No |
| `-h`, `--help` | Show help message | - | - | No |

#### Output

**Comma separated values** representing the graph

| Column name | Type | Description |
|-------------|------|-------------|
| Source | String | The source identifier |
| Target | String | The target identifier |
| Directed | Boolean | True if the edge is directed, False otherwise |
| Source | String | The source where the relationship was extracted from |
| Weight | Float | The weight of the edge |

#### Examples

Build a graph for a list of identifiers:
```shell
python src/build_graph.py data/identifiers.txt
```

Build a graph for a list of identifiers with a depth of 2:
```shell
python src/build_graph.py data/identifiers.txt -d 2
```

Build a graph for a list of identifiers with a STRING combined score threshold of 900:
```shell
python src/build_graph.py data/identifiers.txt -S 900
```

### fetch_kegg_organism.py

#### Description

Fetches all KEGG entries for a specified organism, including pathways and orthologies. The script prints the data to stdout in a tab-separated format.

#### Usage

```shell
python src/fetch_kegg_organism.py [options] <kegg_organism_id>
```

#### Parameters

| Parameter | Description | Type | Default Value | Required |
|-----------|-------------|------|---------------|----------|
| `<kegg_organism>` | KEGG organism ID | String | - | Yes |
| `--log` | log file path | string | info | no |
| `-h`, `--help` | show help message | - | - | no |

#### Output

| Column name | Type | Description |
|-------------|------|-------------|
| KEGG Accession | String | The KEGG accession number |
| Pathways | Array\[String\] | The pathways associated with the entry, separated by semicolons |
| KEGG Orthology | Array\[String\] | The KEGG Orthology (KO) numbers associated with the entry, separated by semicolons |

#### Examples

Fetch KEGG IDs for a specific organism:
```bash
python src/fetch_kegg_organism.py sml
```

Save fetched data to a file:
```bash
python src/fetch_kegg_organism.py sml > kegg_data.txt
```

Chain data fetching and processing:
```bash
python src/fetch_kegg_organism.py sml | tee data.log | python process_data.py
```

### fetch_kegg_relations.py

#### Description


Given a KEGG organism code:
1. Fetches the KGML file for each pathway belonging to the organism.
2. Extracts all the relations for each pathway.

#### Usage

```shell
python src/fetch_kegg_relations.py [options] <kegg_organism_id>
```

#### Parameters

| Parameter | Description | Type | Default Value | Required |
|-----------|-------------|------|---------------|----------|
| `<kegg_organism>` | KEGG organism ID | String | - | Yes |
| `--log` | log file path | string | info | no |
| `-h`, `--help` | show help message | - | - | no |

#### Output

| Column name | Type | Description |
|-------------|------|-------------|
| Source KEGG Accession | String | The source KEGG accession number |
| Target KEGG Accession | String | The target KEGG accession number |
| Pathway ID | String | The pathway ID |
| Relation Type | String | The relation type |
| Relation Subtypes | Array\[String\] | The relation subtypes, separated by semicolons |
| Relation Subtype Values | Array\[String\] | The relation subtype values, separated by semicolons. Mostly used when referring to a compound name |

#### Examples

Fetch relations for a specific organism:
```bash
python src/fetch_kegg_relations.py sml
```

Chain data fetching and processing:
```bash
python src/fetch_kegg_relations.py sml | tee data.log | python process_data.py
```

### fetch_refseq_genome.py

#### Description

Extracts data from a RefSeq annotated genome in GenBank format. Formats extracted data and prints it in tabular format to stdout for downstream processing.

#### Usage

```shell
python src/fetch_refseq_genbank_genome.py [options] <file>
```

#### Parameters

| Parameter | Description | Type | Default Value | Required |
|-----------|-------------|------|---------------|----------|
| `<file>` | GenBank file path, or '-' for stdin | String | '-' | Yes |
| `--log` | log file path | string | info | no |
| `-h`, `--help` | show help message | - | - | no |

#### Output

| Column name | Type | Description |
|-------------|------|-------------|
| RefSeq Locus Tag | String | The RefSeq locus tag |
| Locus Tag | Array\[String\] | The locus tag(s) of the protein, separated by semicolons |
| RefSeq Accession | String | The RefSeq accession number |
| Strand Location | String | The strand location of the protein |
| Start Position | String | The start position of the protein |
| End Position | String | The end position
| Translated Protein Sequence | String | The translated protein sequence |

#### Examples

Fetch data from a GenBank file:
```bash
python src/fetch_refseq_genbank_genome.py data/genbank_file.gb
```

Chain data fetching and processing:
```bash
python src/fetch_refseq_genbank_genome.py data/genbank_file.gb | tee data.log | python process_data.py
```

Obtain context for a specific gene:
```bash
python src/fetch_refseq_genbank_genome.py data/genbank_file.gb | grep -C 10 "MyFavoriteLocusTag"
```

#### Troubleshooting

If a feature is a pseudogene, the build-in functions from Biopython are used to
translate the sequence. When translating a pseudogene,
the translation table is not specified and when a stop codon is found, the
translation is stopped.

### fetch_uniprot_organism_json_entry.py

#### Description

Fetches all UniProt entries for a specified taxon ID. The script prints the data to stdout in a JSON format.

#### Usage

```shell
python src/fetch_uniprot_organism_json_entry.py [options] <taxon_id>
```

#### Parameters

| Parameter | Description | Type | Default Value | Required |
|-----------|-------------|------|---------------|----------|
| `<taxon_id>` | Taxon ID of the organism | Integer | - | Yes |
| `--log` | log file path | string | info | no |
| `-h`, `--help` | show help message | - | - | no |

#### Output

A JSON file containing `results` as the root key.
Each entry in the different arrays from the `results` array is a JSON object representing a UniProt entry.

#### Examples

Fetch UniProt entries for a specific taxon ID:
```bash
python src/fetch_uniprot_organism_json_entry.py 522373
```

### match_ids.py

#### Description

Creates a ID map file using the IDs from three different inputs: UniProt, RefSeq, and KEGG.
The generated file will map the different IDs present in the database.

#### Usage

```shell
python src/match_ids.py [options] <uniprot> <refseq> <kegg>
```

#### Parameters

| Parameter | Description | Type | Default Value | Required |
|-----------|-------------|------|---------------|----------|
| `<uniprot>` | UniProt ID file path | String | - | Yes |
| `<refseq>` | RefSeq ID file path | String | - | Yes |
| `<kegg>` | KEGG ID file path | String | - | Yes |
| `--log` | log file path | string | info | no |

#### Input Files

Input Format (UniProt):
| Column name | Type | Description |
|-------------|------|-------------|
| UniProt Primary Accession Number | String | The UniProt primary accession number |
| Locus Tag | Array\[String\] | The locus tag(s) of the protein, separated by semicolons |
| ORF Names | Array\[String\] | The ORF name(s) of the protein, separated by semicolons |
| KEGG Accession Number | Array\[String\] | The KEGG accession number(s) of the protein, separated by semicolons |
| RefSeq Protein ID | String | The RefSeq protein ID |

Input Format (RefSeq):
| Column name | Type | Description |
|-------------|------|-------------|
| RefSeq Locus Tag | String | The RefSeq locus tag |
| Locus Tag | Array\[String\] | The locus tag(s) of the protein, separated by semicolons |
| RefSeq Accession | String | The RefSeq accession number |

Input Format (KEGG):
| Column name | Type | Description |
|-------------|------|-------------|
| KEGG Accession | String | The KEGG accession number |

#### Output

| Column name | Type | Description |
|-------------|------|-------------|
| UniProt Primary Accession Number | String | The UniProt primary accession number |
| RefSeq Locus Tag | String | The RefSeq locus tag |
| Locus Tag | Array\[String\] | The locus tag(s) of the protein, separated by semicolons |
| KEGG Accession Number | Array\[String\] | The KEGG accession number(s) of the protein, separated by semicolons |
| RefSeq Protein ID | String | The RefSeq protein ID |

#### Examples

Match IDs from different sources:
```bash
python src/match_ids.py data/uniprot_data.tsv data/refseq_data.tsv data/kegg_data.tsv
```

### printval.py

#### Description

Print tables, columns, values or types from the database.

#### Usage

```shell
python src/printval.py [options] <table> <columns>
```

#### Parameters

| Parameter | Description | Type | Default Value | Required |
|-----------|-------------|------|---------------|----------|
| `<table>` | Name of the database table to query. Use 'list' to display all tables. | String | 'list' | Yes |
| `<columns>` | Specific columns to display. Use commas for separating multiple columns. Use 'list' to display all columns. | String | 'list' | No |
| `--db` | Database connection string | String | Reads from `config/database.json` | No |
| `--log` | Log file path | String | INFO | No |
| `-h`, `--help` | Show help message | - | - | No |

#### Output

A tabular file with the requested data. Format follows same conventions as the rest of the scripts.

#### Examples

Display all tables in the database:
```shell
python src/printval.py list
```

Display all columns from the 'uniprot_protein' table:
```shell
python src/printval.py uniprot list
```

Fetch all 'uniprot_accession' from 'uniprot_protein':
```shell
python src/printval.py uniprot uniprot_accession
```

Retrieve 'uniprot_accession', 'locus_tag' from 'ec_number':
```shell
python src/printval.py uniprot uniprot_accession,locus_tag,ec_number
```

Retrieve 'uniprot_accession' from 'uniprot_keyword' where 'keyword' is 'KW-0418':
```shell
python src/printval.py uniprot_keyword uniprot_accession | grep "KW-0418" | cut -f 1
```

### process_uniprot_json_entry.py

#### Description

Given a JSON file containing one or multiple UniProt entries, as retrieved from the UniProt API,
this script will extract the relevant information and write it to a tab-separated file.

#### Usage

```shell
python src/process_uniprot_json_entry.py [options] <file>
```

#### Parameters

| Parameter | Description | Type | Default Value | Required |
|-----------|-------------|------|---------------|----------|
| `<file>` | File containing UniProt JSON entries, or '-' for stdin | String | '-' | Yes |
| `--log` | Log file path | String | INFO | No |
| `-h`, `--help` | Show help message | - | - | No |

#### Output

| Column name | Type | Description |
|-------------|------|-------------|
| Primary Accession | String | The primary UniProt accession number |
| Locus Tag | Array\[String\] | The locus tag(s) of the protein, separated by semicolons |
| ORF Names | Array\[String\] | The ORF name(s) of the protein, separated by semicolons |
| KEGG Accession | Array\[String\] | The KEGG accession number(s) of the protein, separated by semicolons |
| RefSeq Protein ID | String | The RefSeq protein ID |
| EMBL Protein ID | String | The EMBL protein ID |
| Keywords | Array\[String\] | The keywords associated with the protein, separated by semicolons |
| Protein Name | String | The name of the protein |
| Protein Existence | Integer | The protein existence |
| Sequence | String | The sequence of the protein |
| GO Terms | Array\[String\] | The GO terms associated with the protein, separated by semicolons |
| EC Numbers | Array\[String\] | The EC numbers associated with the protein, separated by semicolons |
| Post-translational Modifications | String | The post-translational modifications in JSON format |

#### Examples

Process a JSON file containing UniProt entries:
```shell
python src/process_uniprot_json_entry.py data/uniprot_data.json
```

Process a JSON file containing UniProt entries and save the output to a file:
```shell
python src/process_uniprot_json_entry.py data/uniprot_data.json > uniprot_data.tsv
```

### tab_to_fasta.py

#### Description

Converts a tab-separated file containing protein sequences to a FASTA file.

#### Usage

```shell
python src/tab_to_fasta.py [options] <file>
```

#### Parameters

| Parameter | Description | Type | Default Value | Required |
|-----------|-------------|------|---------------|----------|
| `<file>` | File containing tabular data, or '-' for stdin | String | '-' | Yes |
| `--log` | Log file path | String | INFO | No |
| `-h`, `--help` | Show help message | - | - | No |

#### Input Format

| Column name | Type | Description |
|-------------|------|-------------|
| Identifier | String | The identifier of the protein |
| Sequence | String | The sequence of the protein |

#### Output

A FASTA file containing the protein sequences.

#### Examples

Convert a tab-separated file to a FASTA file:
```shell
python src/tab_to_fasta.py data/protein_sequences.tsv
```

Convert a tab-separated file to a FASTA file and save the output to a file:
```shell
python src/printval.py refseq refseq_locus_tag,translated_protein_sequence | python src/tab_to_fasta.py > proteome.fasta
```

## upsert_table.py

### Description

Read a TSV file, validate, and upsert the data into a table in a database. Creates the table if it does not exist

### Usage

```shell
python src/upsert_table.py <table_type> [options]
```

To get more information about the upsert operation on each type of table, use:
```shell
python src/upsert_table.py <table_type> -h
```

### Table Types

#### id_mappper

##### Input Format

Expects the output generated by the [`match_ids.py`](#match_idspy) script.

#### uniprot

##### Input Format

The expected input format is a tab-separated file
as the one generated by the [`process_uniprot_json_entry.py`](#process_uniprot_json_entrypy) script.

#### refseq

##### Input Format

The expected input format is a tab-separated file as the one generated by the `fetch_refseq_genome.py` script. See [fetch_refseq_genbank_genome.py](#fetch_refseq_genomepy) for more information.

#### kegg

##### Input Format

The expected input format is a tab-separated file as the one generated by the `fetch_kegg_organism.py` script. See [fetch_kegg_organism.py](#fetch_kegg_organismpy) for more information.

#### kegg_relations

##### Input Format

Expects the output generated by the [`fetch_kegg_relations.py`](#fetch_kegg_relationspy) script.

#### string_interactions

##### Input Format

See the [Data Preprocessing](DataPreprocessing.html) section for more information about the expected input format.

#### experimental_condition

#### transcroptomics

#### transcriptomics_counts



